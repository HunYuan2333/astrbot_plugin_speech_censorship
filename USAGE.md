# 插件使用说明

## 测试命令

### `/test_ban` - 测试禁言功能

**用途：** 验证插件的禁言功能是否正常工作

**使用方法：**

1. 确保 Bot 已加入群聊且为管理员
2. 在群聊中发送：`/test_ban`
3. 发送者会被禁言 1 分钟

**预期结果：**

- ✅ 成功：群内会显示 "✅ 测试成功！用户 XXX 已被禁言 60 秒..."
- ❌ 失败：会显示具体的错误原因（如权限不足、API 调用失败等）

**注意事项：**

- 被禁言的用户看不到 Bot 的回复消息（这是正常的）
- 其他群成员可以看到测试结果
- 如果测试失败，请检查：
  - Bot 是否为群管理员或群主
  - 是否使用了 QQ 平台（aiocqhttp 适配器）
  - NapCat 或 go-cqhttp 配置是否正确

## 实际使用

插件会自动在后台工作，无需手动触发。

### 工作流程：

1. **消息累积**
   - 插件监听所有群聊消息
   - 按群组和用户分类存储

2. **触发检测**
   - 根据配置的触发模式自动触发
   - 三种模式：仅时间、仅数量、混合

3. **LLM 分析**
   - 批量发送消息给 LLM
   - 识别违规内容和用户

4. **自动禁言**
   - 对违规用户执行禁言
   - 发送警告消息（可配置）

### 查看日志

在 AstrBot 的日志中可以看到：

```
[INFO] 群聊消息审核插件已加载
[INFO] 定时检测任务已启动（间隔: 60 秒，模式: hybrid）
[INFO] 群 123456 累积消息: 总共 5 条
[INFO] 开始分析群 123456 的 10 条消息...
[INFO] 检测到 1 个违规用户
[INFO] 禁言用户 789012（群: 123456，原因: 阴阳怪气，时长: 600 秒）
[INFO] 禁言成功: 用户 789012
```

## 配置建议

### 低频群组（< 10 条消息/小时）

```json
{
  "trigger_mode": "count_only",
  "batch_size": 20,
  "ban_duration": 300
}
```

### 中频群组（10-100 条消息/小时）

```json
{
  "trigger_mode": "hybrid",
  "check_interval": 60,
  "batch_size": 10,
  "ban_duration": 600
}
```

### 高频群组（> 100 条消息/小时）

```json
{
  "trigger_mode": "time_only",
  "check_interval": 120,
  "ban_duration": 900
}
```

## 白名单设置

### 群组白名单

在 `enabled_groups` 中填写群号，仅对这些群生效：

```json
{
  "enabled_groups": ["123456789", "987654321"]
}
```

留空则对所有群生效。

### 用户白名单

在 `whitelist_users` 中填写 QQ 号，这些用户的消息不会被检测：

```json
{
  "whitelist_users": ["10001", "10002"]
}
```

建议将管理员添加到白名单。

## 调整禁言策略

### 自定义警告消息

```json
{
  "warning_template": "⚠️ @{user} 因{reason}被禁言{duration}秒，请文明发言！"
}
```

支持的变量：

- `{user}` - 用户 QQ 号
- `{reason}` - 违规原因
- `{duration}` - 禁言时长

### 关闭警告消息

```json
{
  "send_warning": false
}
```

## 故障排查

### 问题：禁言不生效

**检查清单：**

1. Bot 是否为群管理员？
2. 是否使用 QQ 平台（aiocqhttp）？
3. 查看日志中的错误信息
4. 尝试运行 `/test_ban` 命令测试

### 问题：LLM 没有正确识别违规内容

**可能原因：**

1. LLM 模型能力不足 → 使用更强大的模型
2. 消息上下文不够 → 增加 `batch_size`
3. Prompt 需要优化 → 修改 main.py 中的 prompt

### 问题：Token 消耗过大

**优化建议：**

1. 使用 `count_only` 模式，增加 `batch_size`
2. 使用 `time_only` 模式，增加 `check_interval`
3. 设置 `enabled_groups` 仅对特定群生效
4. 使用成本更低的 LLM 模型

## 技术支持

遇到问题？可以：

1. 查看 AstrBot 日志文件
2. 检查插件配置是否正确
3. 运行 `/test_ban` 验证基础功能
4. 参考 README.md 中的常见问题
